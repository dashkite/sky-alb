Listener:
  Type: AWS::ElasticLoadBalancingV2::Listener
  DependsOn:
    - LoadBalancer
    - TargetGroup
  Properties:
    LoadBalancerArn: !Ref LoadBalancer
    Port: 443
    Protocol: HTTPS
    {{!-- From https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-https-listener.html It is the most restrictive policy supported as of this writing --}}
    SslPolicy: ELBSecurityPolicy-TLS-1-2-2017-01
    Certificates:
      - CertificateArn: {{certificate.arn}}
    DefaultActions:
      - Type: forward
        TargetGroupArn: !Ref TargetGroup

APIKeyMatchSet:
  Type: AWS::WAFRegional::ByteMatchSet
  Properties:
    Name: API Key Match Set for {{name}}
    ByteMatchTuples:
      - FieldToMatch:
          Type: HEADER
          Data: x-api-key
        PositionalConstraint: EXACTLY
        TargetString: '{{{apiKey}}}'
        TextTransformation: NONE

APIKeyRule:
  Type: AWS::WAFRegional::Rule
  DependsOn:
    - APIKeyMatchSet
  Properties:
    Name: API Key Rule for {{name}} ALB
    MetricName: APIKeyRule{{sname}}
    Predicates:
      - Type: ByteMatch
        Negated: false
        DataId: !Ref APIKeyMatchSet

WAF:
  Type: AWS::WAFRegional::WebACL
  DependsOn:
    - APIKeyRule
  Properties:
    Name: WAF for {{name}} ALB
    MetricName: {{sname}}
    DefaultAction:
      Type: BLOCK
    Rules:
      - Action:
          Type: ALLOW
        Priority: 1
        RuleId: !Ref APIKeyRule

WAFAssociation:
  Type: AWS::WAFRegional::WebACLAssociation
  DependsOn:
    - LoadBalancer
    - WAF
  Properties:
    ResourceArn: !Ref LoadBalancer
    WebACLId: !Ref WAF

DNS:
  Type: "AWS::Route53::RecordSetGroup"
  DependsOn:
    - Listener
  Properties:
    Comment: Direct endpoint for Sky API {{name}}
    HostedZoneId: {{zone.id}}
    RecordSets:
      - Name: {{domain}}
        Type: A
        AliasTarget:
          DNSName: !GetAtt [ LoadBalancer, DNSName ]
          EvaluateTargetHealth: false
          HostedZoneId: !GetAtt [ LoadBalancer, CanonicalHostedZoneID ]
